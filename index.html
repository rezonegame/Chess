<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¬¢ä¹æ£‹ç‰Œå®¤ | 30æ¬¾ç»å…¸æ¸¸æˆ</title>
    <style>
        /* --- 1. äº²å’ŒåŠ›ä¸»é¢˜é…è‰² (Light & Cozy) --- */
        :root {
            --bg-page: #fdfbf7; /* æš–ç±³è‰²èƒŒæ™¯ */
            --bg-sidebar: #ffffff;
            --text-main: #4a4a4a;
            --text-sub: #888888;
            --accent-color: #ff9f43; /* æ¸©æš–çš„æ©™è‰² */
            --accent-hover: #ffb166;
            --primary-btn: #48dbfb; /* æ´»æ³¼çš„è“è‰² */
            --border-soft: #efece6;
            --shadow-card: 0 10px 20px rgba(0,0,0,0.05);
            --shadow-float: 0 15px 30px rgba(0,0,0,0.1);
            
            /* æ£‹ç›˜æè´¨ */
            --wood-color: #eecfa1;
            --wood-border: #d4a373;
        }

        body {
            font-family: 'Nunito', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-page);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- 2. å¸ƒå±€ç³»ç»Ÿ --- */
        #app-container { display: flex; width: 100%; height: 100%; position: relative; }

        /* ä¾§è¾¹æ  (æ¸¸æˆåˆ—è¡¨) */
        aside {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-soft);
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 20;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: var(--shadow-card);
        }

        .logo-area {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--accent-color);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-icon { font-size: 1.8rem; }

        .game-list {
            flex: 1;
            overflow-y: auto;
            /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
            scrollbar-width: thin;
        }

        .game-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            color: var(--text-main);
            font-weight: 600;
        }
        .game-item:hover { background-color: #f7f7f7; }
        .game-item.active {
            background-color: #fff3e0; /* æµ…æ©™è‰²èƒŒæ™¯ */
            color: var(--accent-color);
            box-shadow: 0 2px 8px rgba(255, 159, 67, 0.2);
        }
        .game-icon { margin-right: 12px; font-size: 1.2rem; }
        .game-tag {
            font-size: 0.7rem;
            background: #eee;
            color: #999;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: auto;
        }

        /* ä¸»ç•Œé¢ */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px; /* ç‚¹é˜µèƒŒæ™¯çº¸è´¨æ„Ÿ */
        }

        /* é¡¶éƒ¨å¯¼èˆªæ¡ */
        header {
            padding: 15px 30px;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-soft);
        }

        .mobile-toggle {
            display: none; /* é»˜è®¤æ¡Œé¢éšè— */
            background: white;
            border: 1px solid #ddd;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            color: var(--accent-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .score-card {
            background: white;
            padding: 8px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            font-size: 0.95rem;
            display: flex;
            gap: 15px;
        }
        .score-num { font-weight: bold; color: var(--accent-color); }

        /* æ¸¸æˆåŒºåŸŸ */
        #game-stage {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: auto;
        }

        .board-wrapper {
            padding: 10px;
            border-radius: 16px;
            background: white;
            box-shadow: var(--shadow-float);
            transition: transform 0.3s;
            position: relative;
        }

        .board { display: grid; gap: 1px; }

        .cell {
            position: relative;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* é€šç”¨æ£‹å­ */
        .piece {
            width: 85%; height: 85%;
            border-radius: 50%;
            transform: scale(0);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2;
        }
        .piece.show { transform: scale(1); }
        /* æ‹Ÿç‰©åŒ–æ£‹å­ï¼šåƒç³–æœ/çŸ³å¤´ */
        .piece.black { 
            background: radial-gradient(circle at 30% 30%, #666, #222); 
            box-shadow: 2px 4px 6px rgba(0,0,0,0.3);
        }
        .piece.white { 
            background: radial-gradient(circle at 30% 30%, #fff, #e0e0e0); 
            box-shadow: 2px 4px 6px rgba(0,0,0,0.2);
            border: 1px solid #ddd;
        }

        /* --- 3. ç‰¹å®šæ¸¸æˆçš®è‚¤ --- */

        /* äº”å­æ£‹ (åŸæœ¨é£) */
        .skin-gomoku {
            background: #deb887; /* æµ…æœ¨è‰² */
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 10px 30px rgba(139, 69, 19, 0.3);
        }
        .skin-gomoku .cell { width: 34px; height: 34px; }
        .skin-gomoku .cell::before { content:''; position:absolute; top:50%; left:0; width:100%; height:1px; background:#8b4513; }
        .skin-gomoku .cell::after { content:''; position:absolute; left:50%; top:0; height:100%; width:1px; background:#8b4513; }

        /* äº•å­—æ£‹ (çº¸ç¬”æ¶‚é¸¦é£) */
        .skin-tictactoe {
            background: #fff;
            padding: 20px;
            border-radius: 20px;
            /* ç½‘æ ¼çº¿ç”¨èƒŒæ™¯æ¸å˜ç”»ï¼Œæ¨¡ä»¿çº¸å¼  */
            background-image: linear-gradient(#ccc 1px, transparent 1px), linear-gradient(90deg, #ccc 1px, transparent 1px);
            background-size: 100px 100px;
            background-position: -2px -2px;
            gap: 0;
        }
        .skin-tictactoe .cell {
            width: 98px; height: 98px;
            font-size: 70px;
            font-family: 'Comic Sans MS', cursive, sans-serif;
        }
        .skin-tictactoe .piece {
            background: none; box-shadow: none; border: none;
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
        }
        /* æ‰‹å†™ä½“é¢œè‰² */
        .t-cross { color: #ff6b6b; filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.1)); }
        .t-circle { color: #4ecdc4; filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.1)); }

        /* å››å­æ£‹ (ç°ä»£ç©å…·é£) */
        .skin-connect4 {
            background: #48dbfb; /* äº®è“ */
            padding: 15px;
            border-radius: 15px;
            border-bottom: 10px solid #0abde3;
            gap: 5px;
        }
        .skin-connect4 .cell {
            width: 55px; height: 55px;
            background: #2e86de; /* æ·±è“å­”æ´ */
            border-radius: 50%;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2);
        }
        .skin-connect4 .piece.black { background: #ff6b6b; box-shadow: inset -2px -2px 5px rgba(0,0,0,0.2); } /* çº¢æ–¹ */
        .skin-connect4 .piece.white { background: #feca57; box-shadow: inset -2px -2px 5px rgba(0,0,0,0.2); } /* é»„æ–¹ */

        /* é»‘ç™½æ£‹ (æ¸…æ–°è‰åœ°é£) */
        .skin-reversi {
            background: #20bf6b; /* é²œè‰³è‰ç»¿ */
            padding: 10px;
            border: 4px solid #168e4e;
            gap: 2px;
        }
        .skin-reversi .cell { width: 45px; height: 45px; background: rgba(0,0,0,0.05); }
        .hint-dot {
            width: 12px; height: 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 50%;
        }

        /* åº•éƒ¨æŒ‰é’®æ  */
        .controls {
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            background: white;
            border-top: 1px solid var(--border-soft);
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn:active { transform: scale(0.95); }
        .btn-main { background: var(--accent-color); color: white; box-shadow: 0 4px 10px rgba(255, 159, 67, 0.4); }
        .btn-sub { background: #f1f2f6; color: var(--text-sub); }
        
        /* é®ç½©å±‚ (ç§»åŠ¨ç«¯ç”¨) */
        #sidebar-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.3);
            z-index: 15;
            display: none;
            backdrop-filter: blur(2px);
        }

        /* --- å“åº”å¼é€‚é… (è§£å†³å·¦ä¾§çœ‹ä¸åˆ°çš„é—®é¢˜) --- */
        @media (max-width: 768px) {
            aside {
                position: absolute;
                left: 0; top: 0; bottom: 0;
                transform: translateX(-100%); /* é»˜è®¤éšè— */
                box-shadow: 2px 0 20px rgba(0,0,0,0.1);
            }
            aside.active { transform: translateX(0); } /* æ¿€æ´»æ—¶æ˜¾ç¤º */
            
            .mobile-toggle { display: block; } /* æ˜¾ç¤ºæ±‰å ¡æŒ‰é’® */
            header { padding: 10px 15px; }
            #game-stage { align-items: flex-start; padding-top: 40px; }
        }

        /* å¼¹çª— */
        #modal {
            position: fixed; top:0;left:0;width:100%;height:100%;
            background: rgba(255,255,255,0.8);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            border: 1px solid #eee;
            animation: popUp 0.3s ease;
        }
        @keyframes popUp { from{transform:scale(0.8);opacity:0} to{transform:scale(1);opacity:1} }

    </style>
</head>
<body>

<!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ é®ç½© -->
<div id="sidebar-overlay" onclick="App.toggleSidebar()"></div>

<div id="app-container">
    <!-- ä¾§è¾¹æ  -->
    <aside id="sidebar">
        <div class="logo-area">
            <span class="logo-icon">ğŸ </span> æ¬¢ä¹æ£‹ç‰Œå®¤
        </div>
        <div class="game-list" id="game-list-container">
            <!-- JS å¡«å……åˆ—è¡¨ -->
        </div>
    </aside>

    <main>
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
                <button class="mobile-toggle" onclick="App.toggleSidebar()">â˜° æ¸¸æˆèœå•</button>
                <h2 id="title-display" style="margin:0; font-size:1.2rem; color:var(--text-main);">äº”å­æ£‹</h2>
            </div>
            
            <div class="score-card">
                <div>æˆ‘ <span id="score-p" class="score-num">0</span></div>
                <div style="color:#ddd">|</div>
                <div>AI <span id="score-a" class="score-num">0</span></div>
            </div>
        </header>

        <div id="game-stage">
            <div id="board-area" class="board-wrapper">
                <!-- æ£‹ç›˜æ¸²æŸ“åŒº -->
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-sub" onclick="App.undo()">â†©ï¸ æ‚”æ£‹</button>
            <button class="btn btn-main" onclick="App.restart()">ğŸ”„ å†æ¥ä¸€å±€</button>
            <button class="btn btn-sub" onclick="App.switchDiff()">ğŸ“ éš¾åº¦: ç®€å•</button>
        </div>
    </main>
</div>

<!-- èƒœåˆ©å¼¹çª— -->
<div id="modal">
    <div class="modal-box">
        <h1 id="modal-title" style="margin:0 0 10px 0; color:var(--accent-color);">èµ¢äº†ï¼</h1>
        <p id="modal-msg" style="color:var(--text-sub);">ä½ çš„æ£‹è‰ºçœŸä¸é”™ã€‚</p>
        <br>
        <button class="btn btn-main" onclick="document.getElementById('modal').style.display='none'; App.restart();">å†ç©ä¸€æ¬¡</button>
    </div>
</div>

<script>
    // --- 1. æ¸¸æˆé…ç½® (30æ¬¾) ---
    const GAMES = [
        { id: 'gomoku', name: 'äº”å­æ£‹', icon: 'âš«', type: 'ready' },
        { id: 'tictactoe', name: 'äº•å­—æ£‹', icon: 'ğŸ“', type: 'ready' },
        { id: 'connect4', name: 'å››å­æ£‹', icon: 'ğŸ”´', type: 'ready' },
        { id: 'reversi', name: 'é»‘ç™½æ£‹', icon: 'âšª', type: 'ready' },
        { id: 'xiangqi', name: 'ä¸­å›½è±¡æ£‹', icon: 'â™Ÿï¸', type: 'wip' },
        { id: 'chess', name: 'å›½é™…è±¡æ£‹', icon: 'â™”', type: 'wip' },
        { id: 'go', name: 'å›´æ£‹', icon: 'ğŸ”²', type: 'wip' },
        { id: 'ludo', name: 'é£è¡Œæ£‹', icon: 'âœˆï¸', type: 'wip' },
        { id: 'checkers', name: 'è·³æ£‹', icon: 'ğŸ’', type: 'wip' },
        { id: 'shogi', name: 'æ—¥æœ¬å°†æ£‹', icon: 'ğŸ¯', type: 'wip' }
    ];
    // å¡«å……å‰©ä½™åç§°
    const extras = ["æ–—å…½æ£‹","å†›æ£‹","ä¹å­æ£‹","å…­å­æ£‹","è¥¿æ´‹è·³æ£‹","åŒé™†æ£‹","å­”æ˜æ£‹","äºšé©¬é€Šæ£‹","æµ·æˆ˜æ£‹","ç‚¹æ ¼æ£‹","ç‹ç‹¸ä¸é¹…","è€é¼ ä¸è±¡","å±é£é©¬","åŸå­æ£‹","è´¯é€šæ£‹","å¤šç±³è¯º","ç‹¼äººæ£‹","è‹æ‹‰å¡å°”å¡”","æ’­æ£‹","æ¡¥ç‰Œ"];
    extras.forEach((n,i) => GAMES.push({id: `ex${i}`, name: n, icon: 'ğŸ²', type: 'wip'}));

    // --- 2. æ ¸å¿ƒæ§åˆ¶å™¨ ---
    const App = {
        game: null,
        scores: { p: 0, a: 0 },
        diff: 'easy',

        init() {
            this.renderList();
            this.loadGame('gomoku'); // é»˜è®¤åŠ è½½äº”å­æ£‹
        },

        renderList() {
            const list = document.getElementById('game-list-container');
            GAMES.forEach(g => {
                const el = document.createElement('div');
                el.className = 'game-item';
                el.innerHTML = `<span class="game-icon">${g.icon}</span> ${g.name} ${g.type==='wip'?'<span class="game-tag">å¾…æ›´æ–°</span>':''}`;
                el.onclick = () => {
                    this.loadGame(g.id);
                    if(window.innerWidth <= 768) this.toggleSidebar(); // æ‰‹æœºç‚¹å‡»åè‡ªåŠ¨æ”¶èµ·
                };
                if(g.type==='wip') el.style.opacity = '0.6';
                list.appendChild(el);
            });
        },

        toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebar-overlay');
            sb.classList.toggle('active');
            ov.style.display = sb.classList.contains('active') ? 'block' : 'none';
        },

        loadGame(id) {
            const info = GAMES.find(g => g.id === id);
            if (info.type === 'wip') {
                alert(`ğŸš§ ${info.name} æ­£åœ¨åˆ¶ä½œä¸­ï¼Œè¯·å…ˆè¯•ç©å‰4æ¬¾ç²¾é€‰æ¸¸æˆï¼`);
                return;
            }

            // æ›´æ–°UI
            document.querySelectorAll('.game-item').forEach(e => e.classList.remove('active'));
            // ç®€å•åŒ¹é…é«˜äº®
            Array.from(document.querySelectorAll('.game-item')).find(e => e.innerText.includes(info.name)).classList.add('active');
            document.getElementById('title-display').innerText = info.name;

            // æ¸…ç†æ—§æ¸¸æˆ
            const container = document.getElementById('board-area');
            container.className = 'board-wrapper'; // é‡ç½®class
            
            // å®ä¾‹åŒ–æ–°æ¸¸æˆ
            if (id === 'gomoku') this.game = new Gomoku();
            else if (id === 'tictactoe') this.game = new TicTacToe();
            else if (id === 'connect4') this.game = new Connect4();
            else if (id === 'reversi') this.game = new Reversi();
            
            container.classList.add(this.game.skin);
            this.game.init();
        },

        restart() { if(this.game) this.game.init(); },
        undo() { if(this.game && this.game.active) this.game.undo(); },
        
        switchDiff() {
            this.diff = this.diff === 'easy' ? 'hard' : 'easy';
            document.querySelector('.btn-sub:last-child').innerText = `ğŸ“ éš¾åº¦: ${this.diff==='easy'?'ç®€å•':'å›°éš¾'}`;
            this.restart();
        },

        end(winner) { // 1=P, 2=AI, 0=Draw
            if(winner===1) { this.scores.p++; this.showModal('ğŸ‰ èƒœåˆ©ï¼', 'å¤ªæ£’äº†ï¼Œä½ æˆ˜èƒœäº† AIï¼'); }
            else if(winner===2) { this.scores.a++; this.showModal('ğŸ’” æƒœè´¥', 'å†è¯•ä¸€æ¬¡ï¼ŒAI å¹¶ä¸æ— æ•Œã€‚'); }
            else { this.showModal('ğŸ¤ å¹³å±€', 'åŠ¿å‡åŠ›æ•Œçš„è¾ƒé‡ã€‚'); }
            document.getElementById('score-p').innerText = this.scores.p;
            document.getElementById('score-a').innerText = this.scores.a;
        },

        showModal(title, msg) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerText = msg;
            document.getElementById('modal').style.display = 'flex';
        }
    };

    // --- 3. æ¸¸æˆå¼•æ“åŸºç±» ---
    class GameBase {
        constructor() {
            this.board = [];
            this.history = [];
            this.turn = 1; // 1=Human, 2=AI
            this.active = true;
            this.container = document.getElementById('board-area');
        }
        
        // æ¸²æŸ“æ£‹å­é€»è¾‘ (å­ç±»å¯è¦†ç›–)
        renderPiece(x, y, p) {
            // é»˜è®¤æ¸²æŸ“é€»è¾‘
            const cells = this.container.querySelectorAll('.cell');
            const idx = y * this.size + x;
            if(cells[idx]) {
                const piece = document.createElement('div');
                piece.className = `piece ${p===1?'black':'white'}`;
                cells[idx].appendChild(piece);
                setTimeout(()=>piece.classList.add('show'), 10);
            }
        }

        makeMove(x, y, p) {
            this.history.push(JSON.parse(JSON.stringify(this.board)));
            this.board[y][x] = p;
            this.renderPiece(x, y, p);
            this.playSound('move');
        }

        undo() {
            if(!this.active || this.history.length < 2 || this.turn !== 1) return;
            this.history.pop(); // pop AI
            this.board = this.history.pop(); // pop & restore P
            this.render(); // full re-render
        }

        switchTurn() {
            if(!this.active) return;
            this.turn = this.turn === 1 ? 2 : 1;
            if(this.turn === 2) setTimeout(() => this.aiMove(), 500);
        }

        playSound(type) {
            // ç®€å•çš„Web Audio
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const g = ctx.createGain();
            osc.connect(g); g.connect(ctx.destination);
            if(type==='move') {
                osc.type='sine'; osc.frequency.value=400; 
                g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime+0.1);
                osc.start(); osc.stop(ctx.currentTime+0.1);
            }
        }
    }

    // --- äº”å­æ£‹ ---
    class Gomoku extends GameBase {
        constructor() { super(); this.size=15; this.skin='skin-gomoku'; }
        
        init() {
            this.board = Array(15).fill().map(()=>Array(15).fill(0));
            this.history=[]; this.turn=1; this.active=true;
            this.render();
        }

        render() {
            this.container.innerHTML = '';
            const el = document.createElement('div');
            el.className = 'board';
            el.style.gridTemplateColumns = `repeat(15, 1fr)`;
            
            for(let y=0; y<15; y++) {
                for(let x=0; x<15; x++) {
                    const c = document.createElement('div');
                    c.className = 'cell';
                    c.onclick = () => this.click(x, y);
                    if(this.board[y][x] !== 0) {
                        const p = document.createElement('div');
                        p.className = `piece ${this.board[y][x]===1?'black':'white'} show`;
                        c.appendChild(p);
                    }
                    el.appendChild(c);
                }
            }
            this.container.appendChild(el);
        }

        click(x, y) {
            if(!this.active || this.turn!==1 || this.board[y][x]!==0) return;
            this.makeMove(x, y, 1);
            if(this.checkWin(x,y,1)) { this.active=false; App.end(1); }
            else this.switchTurn();
        }

        aiMove() {
            // ç®€å•AI: æ‰¾æœ€é«˜åˆ†ç‚¹
            let best = {x:7, y:7, s:-1};
            for(let y=0; y<15; y++) {
                for(let x=0; x<15; x++) {
                    if(this.board[y][x]===0) {
                        let score = Math.random();
                        if(App.diff==='hard') {
                             score += this.eval(x,y,2)*1.1 + this.eval(x,y,1);
                        }
                        if(score > best.s) best = {x, y, s:score};
                    }
                }
            }
            this.makeMove(best.x, best.y, 2);
            if(this.checkWin(best.x,best.y,2)) { this.active=false; App.end(2); }
            else this.switchTurn();
        }

        eval(x,y,p) {
            // ç®€å•è¿å­è¯„ä¼°
            let score=0;
            const dirs=[[1,0],[0,1],[1,1],[1,-1]];
            for(let [dx,dy] of dirs) {
                let c=0;
                for(let k=1;k<5;k++) {
                    let nx=x+dx*k, ny=y+dy*k;
                    if(nx>=0&&nx<15&&ny>=0&&ny<15&&this.board[ny][nx]===p) c++; else break;
                }
                for(let k=1;k<5;k++) {
                    let nx=x-dx*k, ny=y-dy*k;
                    if(nx>=0&&nx<15&&ny>=0&&ny<15&&this.board[ny][nx]===p) c++; else break;
                }
                if(c>=4) score+=10000;
                else if(c===3) score+=1000;
                else if(c===2) score+=100;
            }
            return score;
        }

        checkWin(x,y,p) {
             const dirs=[[1,0],[0,1],[1,1],[1,-1]];
             for(let [dx,dy] of dirs) {
                 let c=1;
                 for(let k of [1,-1]) {
                     let i=1;
                     while(true){
                         let nx=x+dx*i*k, ny=y+dy*i*k;
                         if(nx<0||nx>=15||ny<0||ny>=15||this.board[ny][nx]!==p) break;
                         c++; i++;
                     }
                 }
                 if(c>=5) return true;
             }
             return false;
        }
    }

    // --- äº•å­—æ£‹ (æ¶‚é¸¦é£æ ¼) ---
    class TicTacToe extends Gomoku {
        constructor() { super(); this.size=3; this.skin='skin-tictactoe'; }
        
        render() {
            this.container.innerHTML = '';
            const el = document.createElement('div');
            el.className = 'board';
            el.style.gridTemplateColumns = `repeat(3, 1fr)`;
            el.style.width = 'fit-content';
            
            for(let y=0; y<3; y++) {
                for(let x=0; x<3; x++) {
                    const c = document.createElement('div');
                    c.className = 'cell';
                    c.onclick = () => this.click(x, y);
                    if(this.board[y][x]!==0) this.drawSymbol(c, this.board[y][x]);
                    el.appendChild(c);
                }
            }
            this.container.appendChild(el);
        }
        
        drawSymbol(cell, p) {
            cell.innerHTML = p===1 ? 
                '<div class="piece t-cross">âŒ</div>' : 
                '<div class="piece t-circle">â­•</div>';
            setTimeout(()=>cell.firstChild.classList.add('show'),10);
        }

        click(x, y) {
             if(!this.active || this.turn!==1 || this.board[y][x]!==0) return;
             // æ‰‹åŠ¨å®ç°ï¼Œå› ä¸ºrenderPieceé€»è¾‘ä¸åŒ
             this.history.push(JSON.parse(JSON.stringify(this.board)));
             this.board[y][x] = 1;
             this.drawSymbol(this.container.querySelectorAll('.cell')[y*3+x], 1);
             this.playSound('move');
             
             if(this.checkWin(x,y,1)) { this.active=false; App.end(1); }
             else if(this.board.flat().every(v=>v!==0)) { this.active=false; App.end(0); }
             else this.switchTurn();
        }
        
        aiMove() {
            // Minimax ç®€åŒ–ç‰ˆ
            let empty = [];
            for(let y=0; y<3; y++) for(let x=0; x<3; x++) if(this.board[y][x]===0) empty.push({x,y});
            let move = empty[Math.floor(Math.random()*empty.length)];
            
            // ä¸‹å­
            this.board[move.y][move.x] = 2;
            this.drawSymbol(this.container.querySelectorAll('.cell')[move.y*3+move.x], 2);
            this.playSound('move');
            
            if(this.checkWin(move.x,move.y,2)) { this.active=false; App.end(2); }
            else if(this.board.flat().every(v=>v!==0)) { this.active=false; App.end(0); }
            else { this.turn=1; }
        }

        checkWin(x,y,p) {
             // ç®€å•çš„å…¨ç›˜æ£€æŸ¥ï¼Œå› ä¸º3x3å¾ˆå°
             const b = this.board;
             // æ¨ª
             for(let i=0; i<3; i++) if(b[i][0]==p && b[i][1]==p && b[i][2]==p) return true;
             // ç«–
             for(let i=0; i<3; i++) if(b[0][i]==p && b[1][i]==p && b[2][i]==p) return true;
             // æ–œ
             if(b[0][0]==p && b[1][1]==p && b[2][2]==p) return true;
             if(b[0][2]==p && b[1][1]==p && b[2][0]==p) return true;
             return false;
        }
    }

    // --- å››å­æ£‹ ---
    class Connect4 extends GameBase {
        constructor() { super(); this.rows=6; this.cols=7; this.skin='skin-connect4'; }
        
        init() {
            this.board = Array(6).fill().map(()=>Array(7).fill(0));
            this.history=[]; this.turn=1; this.active=true;
            this.render();
        }

        render() {
            this.container.innerHTML = '';
            const el = document.createElement('div');
            el.className = 'board';
            el.style.gridTemplateColumns = `repeat(7, 1fr)`;
            
            for(let y=0; y<6; y++) {
                for(let x=0; x<7; x++) {
                    const c = document.createElement('div');
                    c.className = 'cell';
                    c.onclick = () => this.clickCol(x);
                    if(this.board[y][x]!==0) {
                        const p = document.createElement('div');
                        p.className = `piece ${this.board[y][x]===1?'black':'white'} show`;
                        c.appendChild(p);
                    }
                    el.appendChild(c);
                }
            }
            this.container.appendChild(el);
        }

        clickCol(x) {
            if(!this.active || this.turn!==1) return;
            const y = this.getDropRow(x);
            if(y===-1) return;
            
            this.makeMove(x, y, 1);
            if(this.checkWin(x,y,1)) { this.active=false; App.end(1); }
            else this.switchTurn();
        }
        
        getDropRow(x) {
            for(let y=5; y>=0; y--) if(this.board[y][x]===0) return y;
            return -1;
        }
        
        renderPiece(x,y,p) {
             const idx = y*7+x;
             const cell = this.container.querySelectorAll('.cell')[idx];
             const piece = document.createElement('div');
             piece.className = `piece ${p===1?'black':'white'}`;
             // æ¨¡æ‹Ÿä¸‹è½åŠ¨ç”»
             piece.style.transform = `translateY(-${y*60}px)`;
             cell.appendChild(piece);
             requestAnimationFrame(() => {
                 piece.style.transition = 'transform 0.5s ease-in';
                 piece.style.transform = 'translateY(0)';
             });
        }

        aiMove() {
            let valid = [];
            for(let c=0; c<7; c++) if(this.getDropRow(c)!==-1) valid.push(c);
            let col = valid[Math.floor(Math.random()*valid.length)];
            
            // ç®€å•é˜²å®ˆ: æ£€æŸ¥ç©å®¶æ˜¯å¦å¿«èµ¢äº†
            if(App.diff==='hard') {
                for(let c of valid) {
                    let r = this.getDropRow(c);
                    this.board[r][c]=1; // å‡è®¾ç©å®¶ä¸‹è¿™é‡Œ
                    if(this.checkWin(c,r,1)) col=c; // å¿…é¡»å µ
                    this.board[r][c]=0;
                }
            }

            let r = this.getDropRow(col);
            this.makeMove(col, r, 2);
            if(this.checkWin(col,r,2)) { this.active=false; App.end(2); }
            else this.switchTurn();
        }
        
        checkWin(x,y,p) {
             // ç®€åŒ–ç‰ˆ Gomoku checkWin
             const dirs=[[1,0],[0,1],[1,1],[1,-1]];
             for(let [dx,dy] of dirs) {
                 let c=1;
                 for(let k of [1,-1]) {
                     let i=1;
                     while(true){
                         let nx=x+dx*i*k, ny=y+dy*i*k;
                         if(nx<0||nx>=7||ny<0||ny>=6||this.board[ny][nx]!==p) break;
                         c++; i++;
                     }
                 }
                 if(c>=4) return true;
             }
             return false;
        }
    }

    // --- é»‘ç™½æ£‹ ---
    class Reversi extends GameBase {
        constructor() { super(); this.size=8; this.skin='skin-reversi'; }
        
        init() {
            this.board = Array(8).fill().map(()=>Array(8).fill(0));
            this.board[3][3]=2; this.board[3][4]=1; this.board[4][3]=1; this.board[4][4]=2;
            this.history=[]; this.turn=1; this.active=true;
            this.render();
        }

        render() {
            this.container.innerHTML = '';
            const el = document.createElement('div');
            el.className = 'board';
            el.style.gridTemplateColumns = `repeat(8, 1fr)`;
            
            const moves = this.getMoves(this.turn);
            
            for(let y=0; y<8; y++) {
                for(let x=0; x<8; x++) {
                    const c = document.createElement('div');
                    c.className = 'cell';
                    if(this.board[y][x]!==0) {
                        const p = document.createElement('div');
                        p.className = `piece ${this.board[y][x]===1?'black':'white'} show`;
                        c.appendChild(p);
                    } else if(this.turn===1 && moves.some(m=>m.x===x&&m.y===y)) {
                        const dot = document.createElement('div');
                        dot.className = 'hint-dot';
                        c.appendChild(dot);
                        c.onclick = () => this.click(x,y);
                    }
                    el.appendChild(c);
                }
            }
            this.container.appendChild(el);
        }

        click(x, y) {
            const flips = this.getFlips(x, y, 1);
            if(flips.length>0) {
                this.executeMove(x, y, 1, flips);
            }
        }

        executeMove(x, y, p, flips) {
            this.history.push(JSON.parse(JSON.stringify(this.board)));
            this.board[y][x] = p;
            flips.forEach(pt => this.board[pt.y][pt.x] = p);
            this.playSound('move');
            this.render(); // å¿…é¡»é‡ç»˜ç¿»è½¬

            // æ£€æŸ¥ç»“æŸ
            let black=0, white=0;
            this.board.forEach(r=>r.forEach(v=>{if(v===1)black++;if(v===2)white++;}));
            if(black+white === 64 || black===0 || white===0) {
                this.active=false;
                App.end(black>white?1: (white>black?2:0));
                return;
            }

            this.switchTurn();
        }

        switchTurn() {
            this.turn = 3 - this.turn;
            if(this.getMoves(this.turn).length === 0) {
                this.turn = 3 - this.turn; // å¯¹æ–¹æ— è·¯å¯èµ°ï¼Œè½®æ¬¡ä¸å˜
                if(this.getMoves(this.turn).length === 0) {
                    // åŒæ–¹éƒ½æ— è·¯ï¼Œç»“æŸ
                    let b=0, w=0;
                    this.board.forEach(r=>r.forEach(v=>{if(v===1)b++;if(v===2)w++;}));
                    App.end(b>w?1: (w>b?2:0));
                    return;
                }
            }
            if(this.turn===2) setTimeout(()=>this.aiMove(), 800);
            else this.render();
        }

        getMoves(p) {
            let m=[];
            for(let y=0;y<8;y++) for(let x=0;x<8;x++) 
                if(this.board[y][x]===0 && this.getFlips(x,y,p).length>0) m.push({x,y});
            return m;
        }

        getFlips(x, y, p) {
            let flips = [];
            const dirs = [[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]];
            const opp = 3 - p;
            for (let [dx, dy] of dirs) {
                let temp = [], i=1;
                while(true) {
                    let nx=x+dx*i, ny=y+dy*i;
                    if(nx<0||ny<0||nx>=8||ny>=8) break;
                    if(this.board[ny][nx]===opp) temp.push({x:nx, y:ny});
                    else if(this.board[ny][nx]===p) { flips.push(...temp); break; }
                    else break;
                    i++;
                }
            }
            return flips;
        }

        aiMove() {
            const moves = this.getMoves(2);
            if(!moves.length) return;
            // ç®€å•ç­–ç•¥ï¼šä¼˜å…ˆå è§’
            let best = moves[0];
            const corners = [[0,0],[0,7],[7,0],[7,7]];
            for(let m of moves) {
                if(corners.some(c=>c[0]===m.x && c[1]===m.y)) { best=m; break; }
            }
            this.executeMove(best.x, best.y, 2, this.getFlips(best.x, best.y, 2));
        }
    }

    // å¯åŠ¨
    window.onload = () => App.init();
</script>

</body>
</html>
